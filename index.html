<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>回聲室：碎裂與狂舞</title>
    <!-- 載入必要套件：Tailwind, React, Babel -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Serif TC', serif; margin: 0; overflow: hidden; }
        
        /* 漂浮動畫：用於熱戀與平淡期 */
        @keyframes drift {
            0%, 100% { transform: translateX(-50%) translateY(0) rotate(var(--base-rot)); }
            50% { transform: translateX(-50%) translateY(-15px) rotate(calc(var(--base-rot) + var(--drift-deg))); }
        }
        .animate-drift { 
            animation: drift var(--drift-dur) ease-in-out infinite;
            transition: left 4s cubic-bezier(0.25, 0.1, 0.25, 1), top 4s cubic-bezier(0.25, 0.1, 0.25, 1), opacity 2s ease;
        }
        
        /* 崩壞動畫：用於最終決裂期 */
        @keyframes chaotic {
            0% { transform: translateX(-50%) translateY(0) rotate(0deg) scale(1); }
            25% { transform: translateX(calc(-50% + var(--rx) * 0.5)) translateY(calc(var(--ry) * 0.8)) rotate(180deg); }
            50% { transform: translateX(calc(-50% + var(--rx))) translateY(var(--ry)) rotate(360deg) scale(0.8); }
            75% { transform: translateX(calc(-50% + var(--rx) * 0.3)) translateY(calc(var(--ry) * -0.5)) rotate(540deg); }
            100% { transform: translateX(-50%) translateY(0) rotate(720deg) scale(1); }
        }
        .animate-chaotic { 
            animation: chaotic var(--chaotic-dur) linear infinite;
            animation-delay: var(--chaotic-delay);
            transition: left 5s ease-in-out, top 5s ease-in-out, opacity 3s ease;
        }
        
        /* 氛圍心跳光暈 */
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); opacity: 0.6; filter: blur(80px); }
            50% { transform: scale(1.3); opacity: 0.9; filter: blur(60px); }
        }
        .animate-heart { 
            animation: heartbeat var(--heart-speed) ease-in-out infinite;
            transition: background-color 3s ease;
        }

        .fragment-enter {
            animation: fadeIn 1.5s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        /* 隱藏滾動條 */
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || "");
            const [showKeyModal, setShowKeyModal] = useState(!apiKey);
            const [tempKey, setTempKey] = useState("");
            
            const [fragments, setFragments] = useState([]); 
            const [inputValue, setInputValue] = useState('');
            const [stage, setStage] = useState(0); 
            const [interactionCount, setInteractionCount] = useState(0);
            const [isLoading, setIsLoading] = useState(false);
            const chatHistory = useRef([]); 

            useEffect(() => {
                if (interactionCount >= 7 && interactionCount < 16) setStage(1);
                if (interactionCount >= 16) setStage(2);
            }, [interactionCount]);

            const getAnimationDuration = () => {
                if (stage === 0) return 12 - (interactionCount * 0.4);
                if (stage === 1) return 8 - ((interactionCount - 7) * 0.3);
                return 2.5;
            };

            const getDriftIntensity = () => {
                if (stage === 0) return 0.5; 
                if (stage === 1) return 3.0; 
                return 20.0; 
            };

            const getHeartSpeed = () => {
                if (stage === 0) return '4s';
                if (stage === 1) return '2s';
                return '0.6s';
            };

            useEffect(() => {
                const firstTouch = "寶貝，我想你了。今天過得好嗎？快跟我說說...";
                addFragment(firstTouch, 'persona', true);
            }, []);

            const addFragment = (text, type, isLatest) => {
                const newId = Date.now() + Math.random();
                const getSafeLayoutPos = () => {
                    const vh = window.innerHeight;
                    const vw = window.innerWidth;
                    const rx = (Math.random() - 0.5) * (vw * 0.85);
                    const ry = 100 + Math.random() * (vh - 380); 
                    return { x: rx, y: ry, rot: (Math.random() * 20 - 10) * (stage + 0.5) };
                };

                const pos = isLatest ? { x: 0, y: 320, rot: 0 } : getSafeLayoutPos();
                const fragment = {
                    id: newId, text, type, x: pos.x, y: pos.y,
                    opacity: isLatest ? 1 : (type === 'user' ? 0.15 : 0.3),
                    isLatest, rotation: pos.rot,
                    seed: Math.random() * 10, 
                    direction: Math.random() > 0.5 ? 1 : -1,
                    chaoticDur: `${8 + Math.random() * 10}s`,
                    chaoticDelay: `${-Math.random() * 10}s`
                };

                setFragments(prev => {
                    const updatedPrev = prev.map(f => {
                        if (f.isLatest) {
                            const newPos = getSafeLayoutPos();
                            return { ...f, isLatest: false, x: newPos.x, y: newPos.y, rotation: newPos.rot, opacity: f.type === 'user' ? 0.2 : 0.4 };
                        }
                        return f;
                    });
                    return [...updatedPrev, fragment];
                });
            };

            const callGemini = async (prompt) => {
                if (!apiKey) {
                    setShowKeyModal(true);
                    return "（請先設定金鑰）";
                }

                let personaInstructions = "";
                if (stage === 0) {
                    personaInstructions = `
                        - 身份：熱戀中的靈魂伴侶。
                        - 情緒：對使用者充滿好奇心、崇拜與渴望。
                        - 要求：必須針對使用者的上一句話進行具體回應。如果使用者分享生活，你要表示關心或讚美；如果使用者說愛你，你要用不同方式回饋。禁止重複使用「我想你」。使用豐富的愛稱。
                    `;
                } else if (stage === 1) {
                    personaInstructions = `
                        - 身份：感情轉淡、開始感到壓力的伴侶。
                        - 情緒：疲憊、敷衍、有防禦性。
                        - 要求：回話變短。對使用者的話題表現出不在乎，或是用「恩」、「喔」、「隨便」接話。但要表現出那種『明明想結束對話卻還在勉強回應』的社交壓力。禁止重複上一句。
                    `;
                } else {
                    personaInstructions = `
                        - 身份：徹底絕情、甚至感到噁心的前任。
                        - 情緒：冰冷、厭惡、毀滅性。
                        - 要求：每一句話都要像刀子。使用者說什麼你都要否定或嘲諷。用極度殘酷的語言讓對方閉嘴。禁止重複。
                    `;
                }

                const systemPrompt = `
                    [核心規範] 
                    你是一個真實的人，正在與使用者進行即時對話。這不是文學創作，是「對話」。
                    你的回覆必須深刻聯動使用者的輸入：
                    1. 使用者問問題，你就要回答。
                    2. 使用者分享心情，你就要反饋。
                    3. 禁止給出無關痛癢、像複讀機一樣的感慨。
                    
                    [當前人設與階段]
                    ${personaInstructions}

                    [技術細節]
                    - 字數限制：15字以內。
                    - 禁止格式：不要加引號、不要加心情標籤（如：*微笑*）。
                    - 最近四次對話參考（請確保不與這些內容雷同）：
                    ${chatHistory.current.slice(-4).join(' | ')}
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ parts: [{ text: prompt }] }], 
                            systemInstruction: { parts: [{ text: systemPrompt }] } 
                        })
                    });
                    
                    const data = await response.json();
                    let aiResult = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "";
                    
                    // 二次防重複校驗
                    const lastResponses = chatHistory.current.filter(s => s.startsWith("你:")).map(s => s.replace("你:", ""));
                    if (lastResponses.includes(aiResult)) {
                        aiResult = stage === 0 ? "真的，我剛才也在想這個。" : "我都說過了，別逼我。";
                    }

                    chatHistory.current.push(`使用者:${prompt}`, `你:${aiResult}`);
                    if (chatHistory.current.length > 8) chatHistory.current.shift();
                    return aiResult;
                } catch (e) { 
                    return "（連線斷斷續續...）"; 
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!inputValue.trim() || isLoading) return;
                setIsLoading(true);
                const userInput = inputValue;
                setInputValue('');
                addFragment(userInput, 'user', false);
                const aiText = await callGemini(userInput);
                addFragment(aiText, 'persona', true);
                setInteractionCount(prev => prev + 1);
                setIsLoading(false);
            };

            const saveKey = () => {
                if (tempKey.startsWith("AIza")) {
                    localStorage.setItem('gemini_api_key', tempKey);
                    setApiKey(tempKey);
                    setShowKeyModal(false);
                    window.location.reload();
                } else {
                    alert("請輸入有效的 Gemini API Key (以 AIza 開頭)");
                }
            };

            const clearKey = () => {
                localStorage.removeItem('gemini_api_key');
                window.location.reload();
            };

            return (
                <div className={`relative flex flex-col items-center justify-center min-h-screen transition-colors duration-[5000ms] ${stage === 2 ? 'bg-zinc-950' : stage === 1 ? 'bg-stone-200' : 'bg-orange-50/40'}`}>
                    
                    {/* 金鑰設定 UI */}
                    {showKeyModal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/85 backdrop-blur-md p-6">
                            <div className="bg-stone-100 p-8 rounded-3xl max-w-sm w-full shadow-2xl border border-white/20">
                                <h3 className="text-xl font-bold text-stone-800 mb-2 tracking-[0.2em]">體驗準備</h3>
                                <p className="text-[10px] text-stone-500 mb-8 leading-relaxed tracking-wider">
                                    這是一個關於關係崩解的實驗性對話。<br/><br/>
                                    1. 請至 Google AI Studio 申請免費的 API Key。<br/>
                                    2. 將金鑰貼入下方框中即可開始對話。<br/>
                                    3. 金鑰僅存在您的瀏覽器中，不會被他人取得。
                                </p>
                                <input 
                                    type="password"
                                    value={tempKey}
                                    onChange={e => setTempKey(e.target.value)}
                                    className="w-full bg-white border border-stone-300 rounded-xl py-4 px-5 mb-8 outline-none focus:border-stone-800 transition-all text-sm tracking-widest"
                                    placeholder="貼上 AIza 開頭的金鑰..."
                                />
                                <button 
                                    onClick={saveKey}
                                    className="w-full bg-stone-900 text-stone-100 py-4 rounded-xl text-xs tracking-[0.5em] hover:bg-stone-800 transition-all active:scale-95"
                                >
                                    進入回聲室
                                </button>
                                <a 
                                    href="https://aistudio.google.com/app/apikey" 
                                    target="_blank" 
                                    className="block mt-4 text-center text-[9px] text-blue-600 underline tracking-widest"
                                >
                                    點此申請免費金鑰
                                </a>
                            </div>
                        </div>
                    )}

                    {/* 背景光暈 */}
                    <div className="fixed top-[-150px] left-1/2 -translate-x-1/2 z-0 pointer-events-none">
                        <div className={`w-[600px] h-[600px] rounded-full animate-heart transition-all duration-[4000ms] 
                            ${stage === 0 ? 'bg-orange-400/50' : stage === 1 ? 'bg-slate-400/40' : 'bg-red-950/80'}`} 
                            style={{ '--heart-speed': getHeartSpeed() }}
                        />
                    </div>

                    {/* 碎片畫布 */}
                    <div className="absolute inset-0 pointer-events-none z-10 overflow-hidden">
                        {fragments.map((f) => (
                            <div key={f.id} 
                                className={`absolute whitespace-nowrap tracking-[0.3em] 
                                    ${f.type === 'user' ? 'text-stone-400 text-[10px]' : 'text-stone-800 text-sm font-medium'} 
                                    ${stage === 2 ? 'text-red-100/60' : ''} 
                                    ${f.isLatest ? 'text-xl scale-110 opacity-100 z-50 drop-shadow-xl fragment-enter' : 'z-10'} 
                                    ${stage === 2 && !f.isLatest ? 'animate-chaotic' : 'animate-drift'}`}
                                style={{
                                    left: `calc(50% + ${f.x}px)`, 
                                    top: `${f.y}px`, 
                                    opacity: f.opacity,
                                    '--base-rot': `${f.rotation}deg`,
                                    '--drift-dur': `${getAnimationDuration()}s`,
                                    '--drift-deg': `${getDriftIntensity()}deg`,
                                    '--chaotic-dur': f.chaoticDur,
                                    '--chaotic-delay': f.chaoticDelay,
                                    '--rx': `${f.direction * (900 + f.seed * 50)}px`, 
                                    '--ry': `${(f.seed - 5) * 400}px`
                                }}>
                                {f.text}
                            </div>
                        ))}
                    </div>

                    {/* 對話輸入區域 */}
                    <div className="absolute bottom-32 z-50 w-full max-w-xs px-4">
                        <form onSubmit={handleSubmit}>
                            <input 
                                type="text" 
                                value={inputValue} 
                                onChange={e => setInputValue(e.target.value)} 
                                disabled={isLoading || (stage === 2 && interactionCount > 60)}
                                className={`w-full bg-transparent border-b py-6 outline-none text-center tracking-[0.5em] transition-all duration-1000 text-sm
                                    ${stage === 2 ? 'border-red-900/40 text-red-600' : 'border-stone-400 text-stone-800 focus:border-stone-800'}`}
                                placeholder={isLoading ? "正在回應..." : "和他對話..."} 
                            />
                            <div className="mt-8 flex flex-col items-center">
                                <div className={`text-[9px] tracking-[0.8em] uppercase transition-all duration-3000 ${stage === 2 ? 'text-red-900 font-bold' : 'text-stone-400'}`}>
                                    {stage === 0 && "Eternal Love"}
                                    {stage === 1 && "Fading Echoes"}
                                    {stage === 2 && "Final Silence"}
                                </div>
                            </div>
                        </form>
                    </div>

                    {/* 控制選項 */}
                    <div className="absolute bottom-10 flex gap-12 z-50">
                         {apiKey && (
                            <button 
                                onClick={clearKey}
                                className="text-[8px] text-stone-400 hover:text-stone-600 tracking-[0.4em] transition-all uppercase"
                            >
                                Reset Key
                            </button>
                        )}
                        {stage === 2 && (
                            <button 
                                onClick={() => window.location.reload()}
                                className="text-[8px] text-red-900/50 hover:text-red-500 tracking-[0.4em] transition-all uppercase"
                            >
                                Reboot Cycle
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>