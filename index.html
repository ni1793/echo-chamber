<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>回聲室：碎裂與狂舞</title>
    <!-- 載入必要套件：Tailwind, React, Babel, Lucide -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@0.321.0"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Serif TC', serif; margin: 0; overflow: hidden; }
        
        /* 動畫樣式定義 */
        @keyframes drift {
            0%, 100% { transform: translateX(-50%) translateY(0) rotate(0deg); }
            50% { transform: translateX(-50%) translateY(-12px) rotate(var(--drift-deg)); }
        }
        .animate-drift { animation: drift var(--drift-dur) ease-in-out infinite; }
        
        @keyframes chaotic {
            0% { transform: translateX(-50%) rotate(0deg) scale(1); }
            50% { transform: translateX(calc(-50% + var(--rx))) translateY(var(--ry)) rotate(360deg) scale(0.9); }
            100% { transform: translateX(-50%) rotate(720deg) scale(1); }
        }
        .animate-chaotic { animation: chaotic 8s linear infinite; }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }
        .animate-heart { animation: heartbeat 2s ease-in-out infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 這裡填入你的 API Key ---
        const apiKey = "AIzaSyAzsA74ZkkagWWBCe_In3l5NoXy0JkIxIo";

        const App = () => {
            const [fragments, setFragments] = useState([]); 
            const [inputValue, setInputValue] = useState('');
            const [stage, setStage] = useState(0); 
            const [interactionCount, setInteractionCount] = useState(0);
            const [isLoading, setIsLoading] = useState(false);

            // 階段判斷
            useEffect(() => {
                if (interactionCount >= 7 && interactionCount < 16) setStage(1);
                if (interactionCount >= 16) setStage(2);
            }, [interactionCount]);

            // 動態動畫參數
            const getAnimationDuration = () => {
                if (stage === 0) return 12 - (interactionCount * 0.4);
                if (stage === 1) return 8 - ((interactionCount - 7) * 0.3);
                return 1.8;
            };

            const getDriftIntensity = () => {
                if (stage === 0) return 0.2; 
                if (stage === 1) return 1.5; 
                return 15.0; 
            };

            // 初始化：加入首條訊息
            useEffect(() => {
                const firstTouch = "寶貝，我想你了。今天過得好嗎？快跟我說說...";
                addFragment(firstTouch, 'persona', true);
            }, []);

            // 碎片處理邏輯
            const addFragment = (text, type, isLatest) => {
                const newId = Date.now() + Math.random();
                const getSafeLayoutPos = () => {
                    const vh = window.innerHeight;
                    const vw = window.innerWidth;
                    const rx = (Math.random() - 0.5) * (vw - 120);
                    const ry = 150 + Math.random() * (vh - 400); // 確保不遮擋輸入框
                    return { x: rx, y: ry, rot: (Math.random() * 10 - 5) * (stage + 1) };
                };

                const pos = isLatest ? { x: 0, y: 300, rot: 0 } : getSafeLayoutPos();
                const fragment = {
                    id: newId, text, type, x: pos.x, y: pos.y,
                    opacity: isLatest ? 1 : (type === 'user' ? 0.2 : 0.4),
                    isMirrored: stage === 2, isLatest, rotation: pos.rot,
                    seed: Math.random() * 8, direction: Math.random() > 0.5 ? 1 : -1
                };

                setFragments(prev => {
                    const updatedPrev = prev.map(f => {
                        if (f.isLatest) {
                            const newPos = getSafeLayoutPos();
                            return { 
                                ...f, 
                                isLatest: false, 
                                x: newPos.x, 
                                y: newPos.y, 
                                rotation: newPos.rot, 
                                opacity: f.type === 'user' ? 0.2 : 0.4 
                            };
                        }
                        return f;
                    });
                    return [...updatedPrev, fragment];
                });
            };

            // API 呼叫
            const callGemini = async (prompt) => {
                const systemPrompt = `你是一個真實情侶中的一方，正處於感情崩壞中。目前階段：${stage} (0:熱戀, 1:倦怠, 2:絕情)。字數15字內。`;
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ parts: [{ text: prompt }] }], 
                            systemInstruction: { parts: [{ text: systemPrompt }] } 
                        })
                    });
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "...";
                } catch (e) { 
                    console.error(e);
                    return "..."; 
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!inputValue.trim() || isLoading) return;
                setIsLoading(true);
                const userInput = inputValue;
                setInputValue('');
                addFragment(userInput, 'user', false);
                const aiText = await callGemini(userInput);
                addFragment(aiText, 'persona', true);
                setInteractionCount(prev => prev + 1);
                setIsLoading(false);
            };

            const currentDuration = getAnimationDuration();
            const currentIntensity = getDriftIntensity();

            return (
                <div className={`relative flex flex-col items-center justify-center min-h-screen transition-colors duration-[5000ms] ${stage === 2 ? 'bg-zinc-950' : stage === 1 ? 'bg-zinc-100' : 'bg-orange-50/30'}`}>
                    
                    {/* 背景光暈動畫 */}
                    <div className="fixed top-[-80px] left-1/2 -translate-x-1/2 z-0 pointer-events-none">
                        <div className={`w-[400px] h-[400px] rounded-full blur-[80px] transition-all duration-[4000ms] 
                            ${stage === 0 ? 'bg-orange-200/50 animate-heart' : stage === 1 ? 'bg-slate-300/40' : 'bg-red-900/60'}`} 
                        />
                    </div>

                    {/* 句子畫布區 */}
                    <div className="absolute inset-0 pointer-events-none z-10 overflow-hidden">
                        {fragments.map((f) => (
                            <div key={f.id} 
                                className={`absolute whitespace-nowrap tracking-[0.2em] transition-opacity duration-[2000ms] 
                                    ${f.type === 'user' ? 'text-stone-400 text-xs' : 'text-stone-800 text-sm font-medium'} 
                                    ${stage === 2 ? 'text-red-50/80' : ''} 
                                    ${f.isLatest ? 'text-base scale-105 opacity-100 z-50 drop-shadow-sm' : 'z-10'} 
                                    ${stage === 2 && !f.isLatest ? 'animate-chaotic' : 'animate-drift'}`}
                                style={{
                                    left: `calc(50% + ${f.x}px)`, 
                                    top: `${f.y}px`, 
                                    opacity: f.opacity,
                                    transform: `translateX(-50%) rotate(${f.rotation}deg)`,
                                    '--drift-dur': `${currentDuration}s`,
                                    '--drift-deg': `${currentIntensity}deg`,
                                    '--rx': `${f.direction * 800}px`, 
                                    '--ry': `${(f.seed-4)*200}px`
                                }}>
                                {f.text}
                            </div>
                        ))}
                    </div>

                    {/* 下方輸入與 UI */}
                    <div className="absolute bottom-24 z-50 w-full max-w-sm px-10">
                        <form onSubmit={handleSubmit}>
                            <input 
                                type="text" 
                                value={inputValue} 
                                onChange={e => setInputValue(e.target.value)} 
                                disabled={isLoading || (stage === 2 && interactionCount > 40)}
                                className={`w-full bg-transparent border-b py-4 outline-none text-center tracking-[0.3em] transition-all duration-1000
                                    ${stage === 2 ? 'border-red-900/40 text-red-600' : 'border-stone-200 text-stone-700 focus:border-stone-400'}`}
                                placeholder={isLoading ? "..." : "在此留下你的真心..."} 
                            />
                            <div className="mt-8 flex flex-col items-center">
                                <div className={`text-[9px] tracking-[0.5em] uppercase transition-colors duration-2000 ${stage === 2 ? 'text-red-900' : 'text-stone-400'}`}>
                                    {stage === 0 && "Deep Affection"}
                                    {stage === 1 && "Cold Friction"}
                                    {stage === 2 && "The End Of Us"}
                                </div>
                            </div>
                        </form>
                    </div>

                    {stage === 2 && (
                        <button 
                            onClick={() => window.location.reload()}
                            className="absolute bottom-8 text-[10px] text-red-900/60 hover:text-red-700 tracking-[0.4em] transition-all z-50"
                        >
                            重新開始這場夢
                        </button>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>